# Counter ç¤ºä¾‹ - ä»£ç æ£€æŸ¥ä¸æ›´æ–°æ€»ç»“

## âœ… å·²å®Œæˆçš„æ£€æŸ¥å’Œä¿®æ­£

### 1. å‘½åæ£€æŸ¥
æ‰€æœ‰å‘½åå·²ç»Ÿä¸€å¹¶ç¡®è®¤å‡†ç¡®ï¼š

#### å¸ƒå±€æ–‡ä»¶ (`fragment_counter.xml`)
- âœ… `count` - è®¡æ•°å™¨æ˜¾ç¤º TextView
- âœ… `increment` - å¢åŠ æŒ‰é’®
- âœ… `decrement` - å‡å°‘æŒ‰é’®  
- âœ… `reset` - é‡ç½®æŒ‰é’®
- âœ… `counterInfo` - èŒƒå›´æç¤ºæ–‡æœ¬

#### Fragment (`CounterFragment.kt`)
- âœ… ä½¿ç”¨ `binding.count`ã€`binding.increment` ç­‰è®¿é—®è§†å›¾
- âœ… ä½¿ç”¨ k-mvi åº“çš„æ‰©å±•å‡½æ•°ï¼ˆ`collectState`ã€`collectEvent`ã€`doOnClick`ï¼‰
- âœ… å“åº”å¼æ„å›¾æ”¶é›†æ¨¡å¼

#### Contract (`CounterContract.kt`)
- âœ… `State.count` - è®¡æ•°å™¨å€¼
- âœ… `Event.ShowToast` - Toast äº‹ä»¶
- âœ… `Intent.Increment/Decrement/Reset` - ç”¨æˆ·æ„å›¾

#### ViewModel (`CounterViewModel.kt`)
- âœ… `stateFlow` - çŠ¶æ€æµ
- âœ… `eventFlow` - äº‹ä»¶æµ
- âœ… `dispatch()` - æ„å›¾åˆ†å‘å‡½æ•°

### 2. ä»£ç é£æ ¼æ›´æ–°

#### ä»å‘½ä»¤å¼ â†’ å£°æ˜å¼/å“åº”å¼
**ä¹‹å‰** (ä¼ ç»Ÿæ–¹å¼):
```kotlin
// æ‰‹åŠ¨è®¾ç½®ç‚¹å‡»ç›‘å¬
binding.increment.setOnClickListener {
    viewModel.dispatch(Intent.Increment)
}

// æ‰‹åŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
viewLifecycleOwner.lifecycleScope.launch {
    viewLifecycleOwner.repeatOnLifecycle(Lifecycle.State.STARTED) {
        viewModel.stateFlow.collect { state ->
            binding.count.text = state.count.toString()
        }
    }
}
```

**ç°åœ¨** (k-mvi å“åº”å¼æ–¹å¼):
```kotlin
// å“åº”å¼æ„å›¾æµï¼ˆå¸¦é˜²æŠ–ï¼‰
private val intents: Flow<Intent>
    get() = merge(
        incrementDecrementIntents().debounceFirst(600L),
        binding.reset.doOnClick { trySend(Intent.Reset) }.debounceFirst(600L),
    )

private fun incrementDecrementIntents(): Flow<Intent> = merge(
    binding.increment.doOnClick { trySend(Intent.Increment) },
    binding.decrement.doOnClick { trySend(Intent.Decrement) },
)

// è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç† + é«˜æ•ˆéƒ¨åˆ†æ›´æ–° + è®¡ç®—å±æ€§
viewModel.stateFlow.collectState(viewLifecycleOwner) {
    collectPartial(State::countText, binding.count::setText)
    collectPartial(State::showLoading, binding.loadingBar::isVisible::set)
}

// ç±»å‹å®‰å…¨çš„äº‹ä»¶å¤„ç†
viewModel.eventFlow.collectEvent(this) {
    collectParticular<Event.ShowToast> { event ->
        context?.showToast(event.message)
    }
}
```

### 3. æ·»åŠ çš„å®Œæ•´æ–‡æ¡£

#### CounterFragment.kt
- âœ… ç±»çº§åˆ«æ–‡æ¡£ï¼šè¯´æ˜å“åº”å¼/å£°æ˜å¼ MVI å®ç°
- âœ… å…³é”®æ¨¡å¼è¯´æ˜ï¼š
  - å“åº”å¼æ„å›¾æ”¶é›†ï¼ˆå¸¦é˜²æŠ–ï¼‰
  - é«˜æ•ˆçŠ¶æ€è§‚å¯Ÿ
  - ç±»å‹å®‰å…¨äº‹ä»¶å¤„ç†
- âœ… æ¯ä¸ªæ–¹æ³•çš„è¯¦ç»†æ³¨é‡Šï¼š
  - `intents`: åˆ›å»ºå’Œåˆå¹¶æ„å›¾æµï¼ˆå¸¦ 600ms é˜²æŠ–ï¼‰
  - `incrementDecrementIntents()`: åˆ†ç»„çš„å¢å‡æ„å›¾æµ
  - `setupViewModel()`: å“åº”å¼æ„å›¾åˆ†å‘ï¼ˆæ›´æ–°ä¸ºåŒ…å«é˜²æŠ–è¯´æ˜ï¼‰
  - `onDestroyView()`: ViewBinding æ¸…ç†

#### CounterContract.kt
- âœ… æ¯ä¸ªç»„ä»¶ï¼ˆState/Event/Intent/PartialChangeï¼‰éƒ½æœ‰å®Œæ•´è¯´æ˜
- âœ… è§£é‡Š MVI æ¶æ„å„éƒ¨åˆ†çš„ç”¨é€”

#### CounterViewModel.kt
- âœ… ä¸‰ç§ PartialChange æ¨¡å¼çš„è¯¦ç»†å¯¹æ¯”
- âœ… æ¯ç§æ¨¡å¼çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯
- âœ… **é‡è¦æç¤º**ï¼šä¸æ¨èåœ¨ PartialChange å†…éƒ¨åšå¤æ‚é€»è¾‘å¤„ç†

### 4. æ–°å»ºæ–‡æ¡£

#### `COUNTER_SAMPLE_GUIDE.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
åŒ…å«ä»¥ä¸‹ç« èŠ‚ï¼š

1. **æ¦‚è¿°** - ç¤ºä¾‹å±•ç¤ºçš„å†…å®¹
2. **æ¶æ„ç»„ä»¶** - Contract/ViewModel/UI å±‚è¯¦è§£
3. **ä¸‰ç§ PartialChange æ¨¡å¼** - å®Œæ•´ä»£ç ç¤ºä¾‹å’Œè¯´æ˜
4. **MVI æ•°æ®æµ** - å¯è§†åŒ–æµç¨‹å›¾
5. **K-MVI æ ¸å¿ƒæ‰©å±•** - åº“æä¾›çš„ä¾¿åˆ© API
6. **æœ€ä½³å®è·µ** - 5 ä¸ªå…³é”®æœ€ä½³å®è·µï¼ˆå¸¦ç¤ºä¾‹ï¼‰
7. **è¿è¡Œç¤ºä¾‹** - å¦‚ä½•æ„å»ºå’Œè¿è¡Œ
8. **ä¾èµ–é…ç½®** - æ‰€éœ€ä¾èµ–åˆ—è¡¨
9. **æµ‹è¯•** - å•å…ƒæµ‹è¯•ç¤ºä¾‹
10. **å¯¹æ¯”** - ä¼ ç»Ÿæ–¹å¼ vs K-MVI æ–¹å¼

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. å“åº”å¼æ„å›¾æ”¶é›†
ä½¿ç”¨ `doOnClick` + `merge` åˆ›å»ºå£°æ˜å¼æ„å›¾æµï¼Œå®ç°å•å‘æ•°æ®æµï¼š
```
UI â†’ Intent â†’ ViewModel â†’ State â†’ UI
```

### 2. é«˜æ•ˆçš„çŠ¶æ€è§‚å¯Ÿ
`collectPartial` åªåœ¨ç‰¹å®šå±æ€§å˜åŒ–æ—¶æ›´æ–° UIï¼Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ã€‚

### 2.1. è®¡ç®—å±æ€§åˆ†ç¦»å±•ç¤ºé€»è¾‘
ä½¿ç”¨ `State::countText` è®¡ç®—å±æ€§ï¼š
- åˆ†ç¦»ä¸šåŠ¡é€»è¾‘ï¼ˆ`count: Int`ï¼‰å’Œå±•ç¤ºé€»è¾‘ï¼ˆ`countText: String`ï¼‰
- æ”¯æŒæ–¹æ³•å¼•ç”¨ï¼š`binding.count::setText` æ›´ç®€æ´ã€ç±»å‹å®‰å…¨
- æ ¼å¼åŒ–é€»è¾‘é›†ä¸­åœ¨ Stateï¼Œæ˜“äºç»´æŠ¤å’Œå¤ç”¨

### 3. ç±»å‹å®‰å…¨çš„äº‹ä»¶å¤„ç†
`collectParticular<EventType>` æä¾›ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œç¡®ä¿æ‰€æœ‰äº‹ä»¶ç±»å‹éƒ½è¢«å¤„ç†ã€‚

### 4. è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
æ— éœ€æ‰‹åŠ¨ `repeatOnLifecycle`ï¼Œk-mvi æ‰©å±•å‡½æ•°è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸã€‚

### 5. ä¸‰ç§ PartialChange æ¨¡å¼
- **æ¨¡å¼ 1**ï¼ˆå†…è”æ¡ä»¶ï¼‰: ç®€æ´ä½†ä¸æ¨èç”¨äºå¤æ‚é€»è¾‘
- **æ¨¡å¼ 2**ï¼ˆæå‰è¿”å›ï¼‰: **æ¨è** - æ¸…æ™°åˆ†ç¦»é€»è¾‘è·¯å¾„
- **æ¨¡å¼ 3**ï¼ˆFlow å¼‚æ­¥ï¼‰: ç”¨äºå¼‚æ­¥æ“ä½œå’Œå¤šæ¬¡å‘å°„

## ğŸ“‹ æ–‡ä»¶æ¸…å•

```
app/src/main/
â”œâ”€â”€ java/cc/colorcat/mvi/sample/
â”‚   â”œâ”€â”€ CounterContract.kt         âœ… å®Œæ•´æ–‡æ¡£
â”‚   â”œâ”€â”€ CounterViewModel.kt        âœ… å®Œæ•´æ–‡æ¡£ + ä¸‰ç§æ¨¡å¼è¯´æ˜
â”‚   â”œâ”€â”€ CounterFragment.kt         âœ… å®Œæ•´æ–‡æ¡£ + å“åº”å¼æ¨¡å¼
â”‚   â”œâ”€â”€ Utils.kt                   âœ… showToast æ‰©å±•å‡½æ•°
â”‚   â”œâ”€â”€ COUNTER_SAMPLE_GUIDE.md    âœ… æ–°å»º - å®Œæ•´è‹±æ–‡æŒ‡å—
â”‚   â””â”€â”€ SAMPLE_README.md           âš ï¸  æ—§ç‰ˆ - å¯ä»¥åˆ é™¤æˆ–æ›´æ–°
â”‚
â””â”€â”€ res/layout/
    â””â”€â”€ fragment_counter.xml       âœ… Material Design å¸ƒå±€
```

## âœ… éªŒè¯ç»“æœ

- âœ… æ‰€æœ‰å‘½åä¸€è‡´ä¸”å‡†ç¡®
- âœ… å¸ƒå±€ ID ä¸ä»£ç ä¸­çš„å¼•ç”¨åŒ¹é…
- âœ… æ²¡æœ‰ç¼–è¯‘é”™è¯¯ï¼ˆåªæœ‰é¢„æœŸçš„ "æœªä½¿ç”¨" è­¦å‘Šï¼‰
- âœ… æˆåŠŸæ„å»ºé¡¹ç›®
- âœ… æ‰€æœ‰æ–‡æ¡£å®Œæ•´ä¸”å‡†ç¡®
- âœ… ä»£ç é£æ ¼ç»Ÿä¸€ï¼ˆå“åº”å¼/å£°æ˜å¼ï¼‰

## ğŸš€ ä¸‹ä¸€æ­¥

ç¤ºä¾‹ä»£ç å·²ç»å®Œå…¨å‡†å¤‡å¥½ï¼Œå¯ä»¥ï¼š

1. **åœ¨ MainActivity ä¸­ä½¿ç”¨**ï¼š
   ```kotlin
   supportFragmentManager.commit {
       replace(R.id.fragment_container, CounterFragment())
   }
   ```

2. **è¿è¡Œå¹¶æµ‹è¯•**ï¼š
   ```bash
   ./gradlew :app:installDebug
   ```

3. **å­¦ä¹ æ¨¡å¼**ï¼š
   - é˜…è¯» `COUNTER_SAMPLE_GUIDE.md` äº†è§£è¯¦ç»†è¯´æ˜
   - æŸ¥çœ‹ä»£ç ä¸­çš„å†…è”æ³¨é‡Šç†è§£æ¯ä¸ªéƒ¨åˆ†
   - å¯¹æ¯”ä¸‰ç§ PartialChange æ¨¡å¼

4. **æ‰©å±•åŠŸèƒ½**ï¼š
   - æ·»åŠ æ›´å¤šæ„å›¾ï¼ˆå¦‚ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
   - æ·»åŠ å¼‚æ­¥æ“ä½œç¤ºä¾‹
   - æ·»åŠ å•å…ƒæµ‹è¯•

---

**æ€»ç»“**: æ‰€æœ‰å‘½åå·²éªŒè¯å‡†ç¡®ï¼Œä»£ç å·²æ›´æ–°ä¸ºç°ä»£å“åº”å¼é£æ ¼ï¼Œæ–‡æ¡£å®Œæ•´ä¸”è¯¦ç»†ã€‚ç¤ºä¾‹å±•ç¤ºäº† k-mvi åº“çš„æœ€ä½³å®è·µå’Œä¸‰ç§ä¸åŒçš„çŠ¶æ€å¤„ç†æ¨¡å¼ã€‚

